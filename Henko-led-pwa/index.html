<!DOCTYPE html>
<html lang="pt-BR" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculadora de Painel de LED - Henko Produções</title>
    
    <!-- Configuração PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Henko LED">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega a biblioteca html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Carrega a fonte Inter do Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: none;
        }
        /* Custom scrollbar para um visual mais limpo */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e0e7ff;
        }
        ::-webkit-scrollbar-thumb {
            background: #a5b4fc;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #818cf8;
        }
        
        .dark ::-webkit-scrollbar-track {
            background: #374151;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #6b7280;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        .gemini-pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Inter', sans-serif;
            font-size: 0.95em;
            line-height: 1.6;
        }

        .pixel-map-grid {
            display: grid;
            gap: 1px;
            width: 100%;
            height: 100%;
            max-height: 250px; 
            justify-content: center;
            align-content: center;
        }
        
        .cabinet {
            background-color: #3b82f6; 
            border: 1px solid #1d4ed8; 
            width: 100%;
            height: 100%;
            min-width: 3px; 
            min-height: 3px;
            opacity: 0.8;
            transition: all 0.3s ease;
        }
        
        .dark .cabinet {
            background-color: #60a5fa; 
            border: 1px solid #93c5fd; 
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-800 dark:to-gray-900 min-h-screen py-4 px-4 flex items-center justify-center transition-colors duration-300">

    <div class="container mx-auto pb-16 md:pb-0"> <!-- Padding bottom extra para mobile -->
        <div id="printable-content" class="max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-3xl shadow-xl overflow-hidden transform transition-all duration-300 hover:scale-[1.01]">
            
            <!-- Botão de Modo Escuro -->
            <div class="absolute top-4 right-4" data-html2canvas-ignore="true">
                <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 transition-all duration-200">
                    <svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM10 18a1 1 0 01-1-1v-1a1 1 0 112 0v1a1 1 0 01-1 1zM3.05 4.464A1 1 0 101.636 5.88l.707.707a1 1 0 001.414-1.414l-.707-.707zM16.95 15.536a1 1 0 10-1.414-1.414l-.707.707a1 1 0 101.414 1.414l.707-.707zM1 10a1 1 0 011-1h1a1 1 0 110 2H2a1 1 0 01-1-1zM17 10a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1z"></path></svg>
                </button>
            </div>

            <!-- Botão de Instalar App (PWA) - Visível apenas se não estiver instalado -->
            <div id="install-container" class="absolute top-4 left-4 hidden" data-html2canvas-ignore="true">
                <button id="install-btn" class="flex items-center space-x-1 px-3 py-1.5 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-full text-xs font-semibold hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    <span>Instalar App</span>
                </button>
            </div>

            <div class="p-6">
                
                <header class="flex flex-col items-center justify-center mb-4 border-b pb-2 border-blue-100 dark:border-gray-700">
                    <!-- LOGO SVG -->
                    <div class="flex items-center justify-center space-x-3 text-blue-700 dark:text-blue-400 mb-2">
                        <svg class="h-10 w-10 md:h-12 md:w-12" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        <span class="text-3xl font-extrabold tracking-tight">Henko Produções</span>
                    </div>
                    <h1 class="text-xl font-bold text-center text-gray-800 dark:text-gray-100">
                        Calculadora Técnica LED
                    </h1>
                </header>

                <div class="space-y-3 mb-4">
                    <div>
                        <label for="panelType" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Tipo de Placa
                        </label>
                        <select id="panelType" name="panelType" class="w-full px-3 py-2 bg-white dark:bg-gray-700 dark:text-white border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                            <!-- JS popula -->
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label for="desiredW" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Largura (m)
                            </label>
                            <input type="number" id="desiredW" name="desiredW" value="2" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                        <div>
                            <label for="desiredH" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Altura (m)
                            </label>
                            <input type="number" id="desiredH" name="desiredH" value="1.5" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                    </div>
                </div>

                <div class="bg-blue-50 dark:bg-gray-700 p-4 rounded-xl border border-blue-200 dark:border-gray-600 space-y-2 shadow-sm mb-4">
                    <h2 class="text-sm font-semibold text-blue-900 dark:text-blue-200 border-b pb-1 border-blue-200 dark:border-gray-600">
                        Resultados Técnicos
                    </h2>
                    
                    <div class="grid grid-cols-1 gap-1 text-sm">
                        <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-300">Dimensões Reais:</span><span id="totalDimensions" class="font-bold text-blue-700 dark:text-blue-300">0.00m x 0.00m</span></div>
                        <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-300">Área Total:</span><span id="totalArea" class="font-bold text-blue-700 dark:text-blue-300">0.00 m²</span></div>
                        <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-300">Placas (H x V):</span><span id="panelCount" class="font-bold text-blue-700 dark:text-blue-300">0 x 0</span></div>
                        <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-300">Total de Placas:</span><span id="totalPanels" class="font-bold text-blue-700 dark:text-blue-300">0</span></div>
                        <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-300">Resolução:</span><span id="totalResolution" class="font-bold text-blue-700 dark:text-blue-300">0 x 0 px</span></div>
                        <div class="flex justify-between pt-1 border-t border-blue-200 dark:border-gray-600"><span class="text-gray-600 dark:text-gray-300">Peso Total:</span><span id="totalWeight" class="font-bold text-blue-700 dark:text-blue-300">0.00 kg</span></div>
                        <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-300">Consumo (Watts):</span><span id="totalWatts" class="font-bold text-blue-700 dark:text-blue-300">0 W</span></div>
                    </div>
                </div>

                <div class="border border-gray-200 dark:border-gray-600 rounded-xl p-3 bg-gray-50 dark:bg-gray-800">
                    <h2 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 text-center">Esquema de Montagem</h2>
                    
                    <div class="flex flex-col items-center">
                        <div class="w-full flex justify-between text-[10px] text-gray-500 dark:text-gray-400 mb-1 px-4">
                            <span id="mapWidthLabel">0.00m</span>
                            <span id="mapResolutionWLabel">0px</span>
                        </div>
                        
                        <div class="w-3/4 border-b border-gray-400 dark:border-gray-500 relative mb-1">
                            <div class="absolute -bottom-1 left-0 w-px h-2 bg-gray-400 dark:bg-gray-500"></div>
                            <div class="absolute -bottom-1 right-0 w-px h-2 bg-gray-400 dark:bg-gray-500"></div>
                        </div>

                        <div class="flex w-full justify-center items-center">
                            <div class="flex flex-col justify-between h-24 mr-1 text-[10px] text-gray-500 dark:text-gray-400 text-right py-1">
                                <span id="mapHeightLabel">0.00m</span>
                                <div class="h-1/2 border-r border-gray-400 dark:border-gray-500 relative w-2 self-end">
                                    <div class="absolute top-0 right-0 h-px w-2 bg-gray-400 dark:bg-gray-500"></div>
                                    <div class="absolute bottom-0 right-0 h-px w-2 bg-gray-400 dark:bg-gray-500"></div>
                                </div>
                                <span id="mapResolutionHLabel">0px</span>
                            </div>

                            <div class="relative bg-gray-200 dark:bg-gray-700 border border-gray-400 dark:border-gray-500 p-1" style="max-width: 70%;">
                                <div id="pixelMapContainer" class="pixel-map-grid"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="gemini-assistant" class="mt-4 pt-4 border-t border-blue-200 dark:border-gray-600 space-y-3" data-html2canvas-ignore="true">
                    <h3 class="text-sm font-semibold text-blue-800 dark:text-blue-300">
                        ✨ Assistente Técnico ✨
                    </h3>
                    
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button id="gemini-analyze-btn" class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 text-xs font-medium transition-colors">
                            Analisar Qualidade
                        </button>
                        <button id="gemini-client-text-btn" class="flex-1 px-3 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 text-xs font-medium transition-colors">
                            Gerar Resumo (Zap)
                        </button>
                        <button id="download-pdf-btn" class="flex-1 px-3 py-2 bg-red-600 text-white rounded-lg shadow hover:bg-red-700 text-xs font-medium flex items-center justify-center gap-1 transition-colors">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Baixar PDF
                        </button>
                    </div>

                    <div id="gemini-output" class="mt-2 p-3 bg-blue-100 dark:bg-gray-600 rounded-lg min-h-[60px] text-xs transition-all">
                        <p id="gemini-placeholder" class="text-blue-700 dark:text-blue-300">
                            Clique acima para gerar análise ou baixar PDF.
                        </p>
                        <div id="gemini-loading" class="hidden items-center justify-center text-blue-700 dark:text-blue-300">
                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Processando...</span>
                        </div>
                        <pre id="gemini-result" class="hidden text-gray-800 dark:text-gray-100 gemini-pre"></pre>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal de Instalação (PWA) -->
    <div id="install-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 px-4" data-html2canvas-ignore="true">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 max-w-sm w-full relative transform transition-all scale-100">
            <button id="close-modal" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div class="text-center">
                <div class="bg-blue-100 dark:bg-blue-900 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-blue-600 dark:text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                </div>
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Instalar Aplicativo</h3>
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-6">Tenha a calculadora sempre à mão, mesmo sem internet!</p>
                
                <div id="ios-instructions" class="hidden text-left bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-4 text-sm text-gray-700 dark:text-gray-200">
                    <p class="mb-2 font-semibold">No iPhone (Safari):</p>
                    <ol class="list-decimal pl-4 space-y-1">
                        <li>Toque no botão <span class="font-bold">Compartilhar</span> <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg> (quadrado com seta).</li>
                        <li>Role para baixo e selecione <span class="font-bold">"Adicionar à Tela de Início"</span>.</li>
                        <li>Clique em <span class="font-bold">Adicionar</span>.</li>
                    </ol>
                </div>

                <div id="android-instructions" class="hidden text-left bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-4 text-sm text-gray-700 dark:text-gray-200">
                    <p class="mb-2 font-semibold">No Android (Chrome):</p>
                    <ol class="list-decimal pl-4 space-y-1">
                        <li>Toque no menu (três pontinhos).</li>
                        <li>Selecione <span class="font-bold">"Instalar aplicativo"</span> ou "Adicionar à tela inicial".</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts do App e PWA -->
    <script>
        // --- LÓGICA PWA ---
        let deferredPrompt;
        const installBtn = document.getElementById('install-btn');
        const installModal = document.getElementById('install-modal');
        const closeModal = document.getElementById('close-modal');
        const iosInstructions = document.getElementById('ios-instructions');
        const androidInstructions = document.getElementById('android-instructions');

        // Detecta iOS
        const isIos = () => {
            const userAgent = window.navigator.userAgent.toLowerCase();
            return /iphone|ipad|ipod/.test(userAgent);
        }

        // Mostra botão de instalar
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-container').classList.remove('hidden');
        });

        // Se for iOS, mostra botão também (manual)
        if (isIos() && !window.navigator.standalone) {
            document.getElementById('install-container').classList.remove('hidden');
        }

        installBtn.addEventListener('click', () => {
            if (isIos()) {
                // Abre modal com instruções iOS
                installModal.classList.remove('hidden');
                iosInstructions.classList.remove('hidden');
                androidInstructions.classList.add('hidden');
            } else if (deferredPrompt) {
                // Tenta instalação nativa Android
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        document.getElementById('install-container').classList.add('hidden');
                    }
                    deferredPrompt = null;
                });
            } else {
                // Fallback (ex: já instalado ou desktop)
                installModal.classList.remove('hidden');
                androidInstructions.classList.remove('hidden');
                iosInstructions.classList.add('hidden');
            }
        });

        closeModal.addEventListener('click', () => {
            installModal.classList.add('hidden');
        });

        // --- SERVICE WORKER ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registrado!'))
                    .catch(err => console.log('Falha SW:', err));
            });
        }

        // --- LÓGICA DA CALCULADORA ---
        const panelData = {
            'p2.5-50x50': { name: 'P2.5 - 50x50 cm', pxW: 192, pxH: 192, dimW: 0.5, dimH: 0.5, weight: 8.0, watts: 150 },
            'p2.9-50x50': { name: 'P2.9 - 50x50 cm', pxW: 168, pxH: 168, dimW: 0.5, dimH: 0.5, weight: 8.0, watts: 150 },
            'p3.9-50x50': { name: 'P3.9 - 50x50 cm', pxW: 128, pxH: 128, dimW: 0.5, dimH: 0.5, weight: 8.0, watts: 150 },
            'p4.8-50x50': { name: 'P4.8 - 50x50 cm', pxW: 104, pxH: 104, dimW: 0.5, dimH: 0.5, weight: 8.0, watts: 150 },
            'p5.9-50x50': { name: 'P5.9 - 50x50 cm', pxW: 84,  pxH: 84,  dimW: 0.5, dimH: 0.5, weight: 8.0, watts: 150 },
            
            'p2.5-50x100': { name: 'P2.5 - 50x100 cm', pxW: 192, pxH: 384, dimW: 0.5, dimH: 1.0, weight: 13.0, watts: 300 },
            'p2.9-50x100': { name: 'P2.9 - 50x100 cm', pxW: 168, pxH: 336, dimW: 0.5, dimH: 1.0, weight: 13.0, watts: 300 },
            'p3.9-50x100': { name: 'P3.9 - 50x100 cm', pxW: 128, pxH: 256, dimW: 0.5, dimH: 1.0, weight: 13.0, watts: 300 },
            'p4.8-50x100': { name: 'P4.8 - 50x100 cm', pxW: 104, pxH: 208, dimW: 0.5, dimH: 1.0, weight: 13.0, watts: 300 },
            'p5.9-50x100': { name: 'P5.9 - 50x100 cm', pxW: 84,  pxH: 168, dimW: 0.5, dimH: 1.0, weight: 13.0, watts: 300 },
            
            'p8.0-96x96': { name: 'P8.0 - 96x96 cm', pxW: 128, pxH: 128, dimW: 0.96, dimH: 0.96, weight: 25.0, watts: 300 }
        };

        let lastCalculationResults = {};

        // ****** GEMINI API ******
        async function callGeminiAPI(prompt, maxRetries = 3) {
            const geminiOutput = document.getElementById('gemini-output');
            const geminiPlaceholder = document.getElementById('gemini-placeholder');
            const geminiLoading = document.getElementById('gemini-loading');
            const geminiResult = document.getElementById('gemini-result');
            const analyzeBtn = document.getElementById('gemini-analyze-btn');
            const clientTextBtn = document.getElementById('gemini-client-text-btn');
            
            const model = 'gemini-2.5-flash-preview-09-2025';
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                ],
            };

            geminiPlaceholder.classList.add('hidden');
            geminiResult.classList.add('hidden');
            geminiLoading.classList.remove('hidden');
            geminiLoading.classList.add('flex');
            geminiOutput.classList.add('animate-pulse');
            analyzeBtn.disabled = true;
            clientTextBtn.disabled = true;

            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API Error: ${response.status}`);

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        geminiResult.textContent = text.trim();
                        geminiResult.classList.remove('hidden');
                    } else {
                        throw new Error("Resposta vazia.");
                    }
                    break; 

                } catch (error) {
                    console.error(`Tentativa ${attempt + 1} falhou:`, error);
                    attempt++;
                    if (attempt >= maxRetries) {
                        geminiResult.textContent = "Erro ao contatar a IA. Tente novamente.";
                        geminiResult.classList.remove('hidden');
                    } else {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                    }
                }
            }
            
            geminiLoading.classList.add('hidden');
            geminiLoading.classList.remove('flex');
            geminiOutput.classList.remove('animate-pulse');
            analyzeBtn.disabled = false;
            clientTextBtn.disabled = false;
        }

        // --- DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // ****** MODO ESCURO ******
            const themeToggleBtn = document.getElementById('theme-toggle');
            const darkIcon = document.getElementById('theme-toggle-dark-icon');
            const lightIcon = document.getElementById('theme-toggle-light-icon');
            const htmlElement = document.documentElement;

            function applyTheme(theme) {
                if (theme === 'dark') {
                    htmlElement.classList.add('dark');
                    darkIcon.classList.remove('hidden');
                    lightIcon.classList.add('hidden');
                } else {
                    htmlElement.classList.remove('dark');
                    darkIcon.classList.add('hidden');
                    lightIcon.classList.remove('hidden');
                }
            }

            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const initialTheme = savedTheme ? savedTheme : (systemPrefersDark ? 'dark' : 'light');
            applyTheme(initialTheme);
            htmlElement.classList.remove('light');

            themeToggleBtn.addEventListener('click', () => {
                const isDark = htmlElement.classList.contains('dark');
                const newTheme = isDark ? 'light' : 'dark';
                applyTheme(newTheme);
                localStorage.setItem('theme', newTheme);
            });
            
            // ****** PDF GENERATION ******
            document.getElementById('download-pdf-btn').addEventListener('click', function() {
                const element = document.getElementById('printable-content');
                const isDark = document.documentElement.classList.contains('dark');
                
                const originalClasses = element.className;

                element.classList.remove('max-w-2xl', 'mx-auto', 'shadow-xl', 'rounded-3xl', 'transform', 'hover:scale-[1.01]', 'overflow-hidden');
                element.classList.add('w-full'); 

                const opt = {
                    margin:       0.2, 
                    filename:     'Calculo_Painel_Henko.pdf',
                    image:        { type: 'jpeg', quality: 1.0 },
                    html2canvas:  { 
                        scale: 2, 
                        useCORS: true,
                        scrollY: 0,
                        backgroundColor: isDark ? '#1f2937' : '#ffffff' 
                    },
                    jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' },
                    pagebreak:    { mode: ['avoid-all'] }
                };

                html2pdf().set(opt).from(element).save().then(() => {
                    element.className = originalClasses;
                });
            });

            // ****** CALCULADORA ******

            function populatePanelSelector() {
                const panelSelect = document.getElementById('panelType');
                panelSelect.innerHTML = ''; 

                for (const key in panelData) {
                    const panel = panelData[key];
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = panel.name;
                    panelSelect.appendChild(option);
                }
            }

            function drawPixelMap(countH, countV, panel) {
                const container = document.getElementById('pixelMapContainer');
                container.innerHTML = ''; 

                if (countH <= 0 || countV <= 0) return;

                container.style.gridTemplateColumns = `repeat(${countH}, 1fr)`;
                
                const totalCabinets = countH * countV;
                
                if (totalCabinets > 2500) {
                    container.innerHTML = '<div class="col-span-full text-center text-xs text-gray-500">Visualização simplificada.</div>';
                    return;
                }

                for (let i = 0; i < totalCabinets; i++) {
                    const div = document.createElement('div');
                    div.className = 'cabinet';
                    div.style.aspectRatio = `${panel.dimW} / ${panel.dimH}`;
                    container.appendChild(div);
                }
            }

            function calculate() {
                const panelKey = document.getElementById('panelType').value;
                let desiredW = parseFloat(document.getElementById('desiredW').value);
                let desiredH = parseFloat(document.getElementById('desiredH').value);
                
                if (isNaN(desiredW) || desiredW < 0) desiredW = 0;
                if (isNaN(desiredH) || desiredH < 0) desiredH = 0;

                if (!panelData[panelKey]) return;
                
                const panel = panelData[panelKey];

                const countH = panel.dimW > 0 && desiredW > 0 ? Math.ceil(desiredW / panel.dimW) : 0;
                const countV = panel.dimH > 0 && desiredH > 0 ? Math.ceil(desiredH / panel.dimH) : 0;
                
                const totalPxW = panel.pxW * countH;
                const totalPxH = panel.pxH * countV;
                const totalPanels = countH * countV;
                const totalDimW = panel.dimW * countH;
                const totalDimH = panel.dimH * countV;
                const totalArea = totalDimW * totalDimH;
                
                const panelWeight = panel.weight || 0;
                const totalWeight = totalPanels * panelWeight;
                
                const panelWatts = panel.watts || 0;
                const totalWatts = totalPanels * panelWatts;

                lastCalculationResults = {
                    panelName: panel.name,
                    pitch: panel.name.split(' ')[0],
                    totalDimW: totalDimW.toFixed(2),
                    totalDimH: totalDimH.toFixed(2),
                    totalArea: totalArea.toFixed(2),
                    countH: countH,
                    countV: countV,
                    totalPanels: totalPanels,
                    totalPxW: totalPxW,
                    totalPxH: totalPxH,
                    totalWeight: totalWeight.toFixed(2),
                    totalWatts: totalWatts
                };

                document.getElementById('totalResolution').textContent = `${totalPxW} x ${totalPxH} px`;
                document.getElementById('totalDimensions').textContent = `${totalDimW.toFixed(2)}m x ${totalDimH.toFixed(2)}m`;
                document.getElementById('totalArea').textContent = `${totalArea.toFixed(2)} m²`;
                document.getElementById('panelCount').textContent = `${countH} x ${countV}`; 
                document.getElementById('totalPanels').textContent = totalPanels;
                document.getElementById('totalWeight').textContent = `${totalWeight.toFixed(2)} kg`;
                document.getElementById('totalWatts').textContent = `${totalWatts} W`;

                document.getElementById('mapWidthLabel').textContent = `${totalDimW.toFixed(2)}m`;
                document.getElementById('mapResolutionWLabel').textContent = `${totalPxW}px`;
                document.getElementById('mapHeightLabel').textContent = `${totalDimH.toFixed(2)}m`;
                document.getElementById('mapResolutionHLabel').textContent = `${totalPxH}px`;

                drawPixelMap(countH, countV, panel);
            }

            // Init
            populatePanelSelector();

            const panelSelect = document.getElementById('panelType');
            const desiredWInput = document.getElementById('desiredW'); 
            const desiredHInput = document.getElementById('desiredH'); 

            [panelSelect, desiredWInput, desiredHInput].forEach(el => el.addEventListener('input', calculate));

            calculate();

            // ****** GEMINI ******
            const analyzeBtn = document.getElementById('gemini-analyze-btn');
            const clientTextBtn = document.getElementById('gemini-client-text-btn');

            analyzeBtn.addEventListener('click', () => {
                const r = lastCalculationResults;
                if (!r.totalPanels || r.totalPanels === 0) {
                     document.getElementById('gemini-result').textContent = "Insira dimensões válidas.";
                     document.getElementById('gemini-result').classList.remove('hidden');
                     document.getElementById('gemini-placeholder').classList.add('hidden');
                     return;
                }
                const prompt = `Especialista em LED.
                Projeto:
                - Painel: ${r.pitch}
                - Tamanho: ${r.totalDimW}m x ${r.totalDimH}m
                - Resolução: ${r.totalPxW} x ${r.totalPxH}
                - Consumo: ${r.totalWatts} W
                
                Analise (max 3 parágrafos): Qualidade para vídeo HD? Distância mínima? Dimensionamento elétrico básico?
                Responda em PT-BR.`;
                
                callGeminiAPI(prompt);
            });

            clientTextBtn.addEventListener('click', () => {
                const r = lastCalculationResults;
                if (!r.totalPanels || r.totalPanels === 0) {
                     document.getElementById('gemini-result').textContent = "Insira dimensões válidas.";
                     document.getElementById('gemini-result').classList.remove('hidden');
                     document.getElementById('gemini-placeholder').classList.add('hidden');
                     return;
                }
                const prompt = `Técnico Henko Produções.
                Resumo Técnico WhatsApp:
                - Placa: ${r.panelName}
                - Dimensão: ${r.totalDimW}m x ${r.totalDimH}m (${r.totalArea}m²)
                - Resolução: ${r.totalPxW} x ${r.totalPxH}
                - Qtd: ${r.totalPanels} (${r.countH}x${r.countV})
                - Peso Total: ${r.totalWeight} kg
                - Consumo: ${r.totalWatts} W
                
                Gere msg curta e técnica.`;
                
                callGeminiAPI(prompt);
            });

        });
    </script>
</body>
</html>